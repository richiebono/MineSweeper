# Use postgres/example user/password credentials
version: '3.1'

services:

  mine-sweeper-db:
    image: postgres
    container_name: mine-sweeper-db
    restart: always
    environment:
      POSTGRES_USER: ${MINESWEEPER_USER_DB}
      POSTGRES_PASSWORD: ${MINESWEEPER_PASSWORD_DB}
      POSTGRES_DB: ${MINESWEEPER_DB}
    ports:
      - 5432:5432
  
  mine-sweeper-adminer:
    container_name: mine-sweeper-adminer
    image: adminer
    restart: always
    ports:
      - 8080:8080
       
  mine-sweeper-authentication-api:
    container_name: mine-sweeper-authentication-api
    image: mine-sweeper-authentication-api 
    env_file: .env
    environment:
      MINESWEEPER_USER_DB: ${MINESWEEPER_USER_DB}
      MINESWEEPER_PASSWORD_DB: ${MINESWEEPER_PASSWORD_DB}
      MINESWEEPER_DB: ${MINESWEEPER_DB}
      MINESWEEPER_SECRET_JWT: ${MINESWEEPER_SECRET_JWT}
      MINESWEEPER_MONITORING_SERVER: ${MINESWEEPER_MONITORING_SERVER}
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
    build:
      context: .
      dockerfile: MineSweeper.Authentication.Api/Dockerfile
    ports:
      - 8081:8081
    
    depends_on:
      - mine-sweeper-db
       
  mine-sweeper-game-api:
    container_name: mine-sweeper-game-api
    image: minesweeper-game-api 
    env_file: .env
    environment:
      MINESWEEPER_USER_DB: ${MINESWEEPER_USER_DB}
      MINESWEEPER_PASSWORD_DB: ${MINESWEEPER_PASSWORD_DB}
      MINESWEEPER_DB: ${MINESWEEPER_DB}
      MINESWEEPER_SECRET_JWT: ${MINESWEEPER_SECRET_JWT}
      MINESWEEPER_MONITORING_SERVER: ${MINESWEEPER_MONITORING_SERVER}
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
    build:
      context: .
      dockerfile: MineSweeper.Game.Api/Dockerfile
    ports:
      - 8082:8082    
    depends_on:
      - mine-sweeper-db
      - mine-sweeper-authentication-api
       
   mine-sweeper-monitoring:
    container_name: mine-sweeper-monitoring
    image: minesweeper-monitoring 
    build:
      context: .
      dockerfile: MineSweeper.Monitoring/Dockerfile
    ports:
      - 8083:8083
    env_file: .env
    depends_on:      
      - mine-sweeper-authentication-api
      - mine-sweeper-game-api 
      
      
  mine-sweeper-web:
    container_name: mine-sweeper-web
    image: mine-sweeper-web
    env_file: .env
    environment:
      MINESWEEPER_AUTHENTICATION_URL: ${MINESWEEPER_AUTHENTICATION_URL}      
      MINESWEEPER_GAME_URL: ${MINESWEEPER_GAME_URL}
    build:
      context: .
      dockerfile: MineSweeper.Web.React/Dockerfile
    ports:
      - 3001:3000
    volumes:
      - '.:/app'
      - '/app/node_modules'        
    depends_on: 
      - mine-sweeper-authentication-api
      - mine-sweeper-game-api